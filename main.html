<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Meet Your Love - Main</title>
<style>
  :root{--pink:#ff4081;}
  body {font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; padding:0;}
  nav {background:var(--pink); color:white; display:flex; justify-content:space-between; align-items:center; padding:10px 16px; position:sticky; top:0; z-index:10;}
  nav img.logo {height:40px; border-radius:8px;}
  .nav-right{display:flex; align-items:center; gap:14px;}
  .user-info {display:flex; align-items:center; gap:10px; cursor:pointer;}
  .avatar {width:44px; height:44px; border-radius:50%; object-fit:cover; display:block; position:relative;}
  .online-dot {width:12px; height:12px; background:limegreen; border-radius:50%; position:absolute; bottom:0; right:-2px; border:2px solid white;}
  .badge{background:white;color:var(--pink); min-width:20px; padding:2px 6px; border-radius:999px; font-size:.8rem; text-align:center;}
  .container {padding:16px; max-width:1200px; margin:auto;}
  .grid {display:grid; grid-template-columns: 1fr; gap:16px;}
  @media(min-width:900px){ .grid{ grid-template-columns: 320px 1fr; } }
  .card {background:white; border-radius:16px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,.08);}
  h3 {margin:8px 0 12px;}
  input, textarea, select {width:100%; padding:10px; margin:6px 0; border-radius:10px; border:1px solid #ddd; font-size:1rem; background:#fff;}
  button {padding:10px 14px; border:none; border-radius:10px; cursor:pointer; background:var(--pink); color:white; font-weight:600;}
  button.ghost{background:#eee; color:#333;}
  button.icon {display:inline-flex; align-items:center; gap:6px;}
  .row{display:flex; align-items:center; gap:10px;}
  .between{display:flex; align-items:center; justify-content:space-between;}
  .post-media{width:100%; max-height:70vh; border-radius:12px; margin-top:8px; object-fit:contain; background:#000;}
  .user-chip{display:flex; align-items:center; gap:8px;}
  .mini {width:28px; height:28px; border-radius:50%; object-fit:cover; position:relative;}
  .liked-strip{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
  .kebab{background:transparent; color:#333;}
  .kebab::after{content:"⋮"; font-size:22px; line-height:1;}
  .menu{position:absolute; right:10px; top:36px; background:white; border:1px solid #eee; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.1); display:none; min-width:180px; z-index:5;}
  .menu button{width:100%; background:#fff; color:#333; text-align:left; padding:10px 12px; border-radius:0;}
  .menu button:hover{background:#fafafa;}
  .comment-box{display:flex; gap:8px; margin-top:10px;}
  .comment{background:#f7f7f7; border-radius:12px; padding:8px 12px; margin:6px 0;}
  .reply{margin-left:28px;}
  .list{display:flex; flex-direction:column; gap:10px;}
  .notif {display:flex; gap:10px; align-items:center; background:#fff; border:1px solid #eee; padding:10px; border-radius:10px;}
  /* Modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px;}
  .modal .panel{background:#fff; width:100%; max-width:520px; border-radius:16px; padding:16px;}
  .cols{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .chat-box{height:320px; overflow:auto; background:#fafafa; border-radius:10px; padding:10px; margin-bottom:10px;}
  .bubble{max-width:70%; margin:6px 0; padding:8px 12px; border-radius:12px;}
  .me{background:var(--pink); color:white; margin-left:auto;}
  .them{background:#fff; border:1px solid #eee;}
  video::-webkit-media-controls-panel{ background: rgba(0,0,0,0.2); }
</style>
</head>
<body>

<nav>
  <div class="row">
    <img class="logo" src="logo.jpg" alt="Logo" onerror="this.src='https://dummyimage.com/80x40/ff4081/ffffff&text=MYL'">
    <strong style="margin-left:8px;">Meet Your Love</strong>
  </div>
  <div class="nav-right">
    <button id="notifBtn" class="icon"><span>🔔</span><span id="notifCount" class="badge" style="display:none">0</span></button>
    <div id="navbarUser" class="user-info">
      <div style="position:relative;">
        <img id="navProfilePic" class="avatar" src="https://i.ibb.co/4pVBB1K/default-avatar.png" onerror="this.src='https://i.pravatar.cc/100?u=placeholder'"/>
        <span id="navOnline" class="online-dot" style="display:none;"></span>
      </div>
      <span id="navUsername">Username</span>
    </div>
  </div>

  <button id="messageIcon" onclick="goToMessages()" style="position:relative;">
    📩
    <span id="msgNotifBadge" style="position:absolute;top:-5px;right:-5px;background:red;color:white;padding:2px 6px;border-radius:50%;font-size:0.8rem;"></span>
  </button>
</nav>

<div class="container grid">
  <!-- Left: People & Notifications -->
  <div class="card">
    <input type="text" id="searchUser" placeholder="Search users...">
    <div id="usersList" class="list" style="margin-top:10px;"></div>
    <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">
    <div class="between"><h3>Notifications</h3><button class="ghost" id="openNotif">Open</button></div>
    <div id="notifPeek" class="list"></div>
  </div>

  <!-- Right: Composer + Feed -->
  <div>
    <div class="card">
      <h3>Create Post</h3>
      <textarea id="postText" placeholder="Say something nice..."></textarea>
      <div class="between">
        <input type="file" id="postFile" accept="image/*,video/*">
        <button id="postBtn">Post</button>
      </div>
    </div>
    <div id="postsList" class="list" style="margin-top:16px;"></div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="panel">
    <div class="between"><h3>Edit Profile</h3><button class="ghost" onclick="closeModal('profileModal')">Close</button></div>
    <div class="cols">
      <div><label>First name</label><input id="pFirst" /></div>
      <div><label>Surname</label><input id="pSurname" /></div>
    </div>
    <div class="cols">
      <div><label>Username</label><input id="pUsername" /></div>
      <div><label>Date of birth</label><input id="pDob" type="date" /></div>
    </div>
    <div><label>Change profile picture</label><input id="pPic" type="file" accept="image/*" /></div>
    <div class="between" style="margin-top:10px;">
      <button class="ghost" onclick="closeModal('profileModal')">Cancel</button>
      <button onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>
<!-- View User Modal -->
<div id="viewUserModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
</div>

<!-- Profile Modal -->
<div id="profileModal" style="display:none;">
  <input id="pFirst" placeholder="First Name">
  <input id="pSurname" placeholder="Surname">
  <input id="pUsername" placeholder="Username">
  <input id="pDob" type="date">
  <input id="pPic" type="file">
  <button onclick="saveProfile()">Save Profile</button>
  <button onclick="closeModal('profileModal')">Close</button>
</div>

<!-- Notifications Modal -->
<div id="notifModal" style="display:none;">
  <div id="notifList"></div>
  <button onclick="closeModal('notifModal')">Close</button>
</div>

<!-- Notifications Modal -->
<div id="notifModal" class="modal">
  <div class="panel">
    <div class="between"><h3>Notifications</h3><button class="ghost" onclick="closeModal('notifModal')">Close</button></div>
    <div id="notifList" class="list" style="margin-top:10px;"></div>
  </div>
</div>

<!-- Chat Modal -->
<div id="chatModal" class="modal">
  <div class="panel">
    <div class="between"><h3 id="chatWith">Chat</h3><button class="ghost" onclick="closeModal('chatModal')">Close</button></div>
    <div id="chatBox" class="chat-box"></div>
    <div class="row">
      <input id="chatInput" placeholder="Type a message...">
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>
</div>

<div class="user-info">
  <img src="https://i.ibb.co/default-profile.png" alt="Profile">
  <span id="notifBadge" style="background:red;color:white;padding:2px 6px;border-radius:50%;margin-left:5px;"></span>
  <button onclick="openModal('notifModal')">Notifications</button>
</div>

<div id="profileModal" class="modal">
  <div class="modal-content">
    <label>Profile Picture</label>
    <input type="file" id="pPic">
    <img id="pPicPreview" src="https://i.ibb.co/4pVBB1K/default-avatar.png" style="width:100px;height:100px;border-radius:50%">
    
    <label>First Name</label>
    <input id="pFirst" type="text">
    <label>Surname</label>
    <input id="pSurname" type="text">
    <label>Username</label>
    <input id="pUsername" type="text">
    <label>DOB</label>
    <input id="pDob" type="date">
    
    <button onclick="saveProfile()">Save</button>
    <button onclick="closeModal('profileModal')">Cancel</button>
  </div>
</div>

<script type="module">
// ---------------- Firebase ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
  collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDocs 
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLSjPvdhLP4Esh9i0k4Fbe5W3YUlHas94",
  authDomain: "meet-your-love-3c2e9.firebaseapp.com",
  projectId: "meet-your-love-3c2e9",
  storageBucket: "meet-your-love-3c2e9.appspot.com",
  messagingSenderId: "762275409257",
  appId: "1:762275409257:web:374c366cfea5b01dae21f8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------------- Cloudinary ----------------
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dcmudqqsp/upload";
const CLOUDINARY_PRESET = "voice upload";

// ---------------- Globals / State ----------------
let me = null;
let meId = null;

// ---------------- Helper ----------------
const $ = sel => document.querySelector(sel);
const el = (tag, html) => { const d = document.createElement(tag); d.innerHTML = html; return d; };
const timeStr = ts => ts?.seconds ? new Date(ts.seconds*1000).toLocaleString() : "";

// ---------------- Presence ----------------
async function setActive(isActive){
  if(!meId) return;
  try { await updateDoc(doc(db,"users",meId), { isActive, lastSeen: serverTimestamp() }); } catch(e){}
}
window.addEventListener("beforeunload", ()=> setActive(false));

// ---------------- Auth Bootstrap ----------------
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href="index.html"; return; }
  meId = user.uid;
  const uDoc = await getDoc(doc(db,"users",meId));
  me = uDoc.data() || {};

  $("#navProfilePic").src = me.profilePic || "https://i.ibb.co/4pVBB1K/default-avatar.png";
  $("#navUsername").textContent = me.username || "Username";
  $("#navOnline").style.display = "inline-block";
  $("#navbarUser").onclick = openProfile;

  await setActive(true);

  bindUsers();
  bindNotifications();
  bindPosts();
});

// ---------------- Users List ----------------
function bindUsers(){
  const search = $("#searchUser");
  const unsub = onSnapshot(collection(db,"users"), snap=>{
    const q = (search.value||"").toLowerCase();
    const list = $("#usersList"); list.innerHTML="";
    snap.forEach(d=>{
      const u = d.data(); const uid = d.id;
      if(uid===meId) return; // skip yourself
      if(q && !(u.username||"").toLowerCase().includes(q)) return;

      const card = el("div", `
        <div class="between" style="gap:10px;">
          <div class="user-chip" onclick="viewUserProfile('${uid}')">
            <div style="position:relative;">
              <img class="mini" src="${u.profilePic||'https://i.ibb.co/4pVBB1K/default-avatar.png'}" 
                   onerror="this.src='https://i.pravatar.cc/100?u=${uid}'">
              ${u.isActive ? '<span class="online-dot" style="position:absolute; bottom:-2px; right:-2px;"></span>': ''}
            </div>
            <div>
              <div><strong>${u.username||'User'}</strong></div>
              <div style="font-size:.85rem;color:#777;">${u.firstName||''} ${u.surname||''}</div>
            </div>
          </div>
          <div class="row">
            <button class="ghost" 
              onclick="startMessage('${uid}','${u.username||'User'}','${u.profilePic||''}',event)">Message</button>
          </div>
        </div>
      `);

      list.appendChild(card);
    });
  });

  search.oninput = ()=> { unsub(); bindUsers(); };
}
window.bindUsers = bindUsers;

// ---------------- Start Message ----------------
window.startMessage = function(friendId, friendName, friendPic, event){
  event.stopPropagation(); // prevent also opening profile
  // Save friend info to localStorage for message.html
  localStorage.setItem("chatFriendId", friendId);
  localStorage.setItem("chatFriendName", friendName);
  localStorage.setItem("chatFriendPic", friendPic);
  // Go to message page
  window.location.href = "message.html";
}


// ---------------- View User Profile ----------------
async function viewUserProfile(uid){
  const uDoc = await getDoc(doc(db,"users",uid));
  if(!uDoc.exists()) return alert("User not found");
  const u = uDoc.data();
  const modal = $("#viewUserModal");
  
  modal.innerHTML = `
    <div style="text-align:center;">
      <img src="${u.profilePic||'https://i.ibb.co/4pVBB1K/default-avatar.png'}" style="width:200px;height:200px;border-radius:50%">
      <h3>${u.username||"User"}</h3>
      <button onclick="downloadImage('${u.profilePic||''}')">Download Profile Picture</button>
      <button onclick="startChat('${uid}','${u.username||"User"}')">Message</button>
    </div>
    <button onclick="closeModal('viewUserModal')">Close</button>
  `;
  openModal("viewUserModal");
}

window.viewUserProfile = viewUserProfile;

function startChat(uid, username){
  // Redirect to message.html and pass user ID and name in URL
  const params = new URLSearchParams();
  params.set("peerId", uid);
  params.set("peerName", username);
  window.location.href = "message.html?" + params.toString();
}
window.startChat = startChat;


// ---------------- Friend Requests ----------------
window.sendFriendRequest = async (friendId,event)=>{
  event.stopPropagation();
  if(friendId===meId) return alert("Cannot add yourself");

  const q = query(collection(db,"friendRequests"),where("from","==",meId),where("to","==",friendId));
  const snap = await getDocs(q); if(!snap.empty) return alert("Request already sent");

  const friendDoc = await getDoc(doc(db,"users",friendId));
  const friendUsername = friendDoc.exists()?friendDoc.data().username:"User";

  // Add friend request
  await addDoc(collection(db,"friendRequests"),{
    from:meId,
    fromUsername:me.username||"User",
    to:friendId,
    toUsername:friendUsername,
    status:"pending",
    createdAt:serverTimestamp()
  });

  // Add notification
  await addDoc(collection(db,"notifications"),{
    to:friendId,
    from:meId,
    fromName: me.username || "User",
    fromPhoto: me.profilePic || "",
    type:"friend_request",
    text: `${me.username || "Someone"} sent you a friend request`,
    read:false,
    createdAt:serverTimestamp()
  });

  alert("Friend request sent!");
};

// ---------------- Notifications ----------------
function bindNotifications(){
  const q = query(collection(db,"notifications"), where("to","==",meId));
  onSnapshot(q, snap=>{
    const list = $("#notifList"); list.innerHTML="";
    snap.forEach(d=>{
      const n = d.data();
      const row = el("div", `
        <div class="notif">
          <img class="mini" src="${n.fromPhoto||'https://i.ibb.co/4pVBB1K/default-avatar.png'}">
          <div><strong>${n.fromName||'Someone'}</strong> ${n.text||''}</div>
        </div>
      `);
      list.appendChild(row);
    });
  });
}
window.bindNotifications = bindNotifications;

// ---------------- Posts / Feed ----------------
function bindPosts(){
  const q = query(collection(db,"posts"), orderBy("timestamp","desc"));
  onSnapshot(q, snap=>{
    const feed = $("#postsList"); feed.innerHTML="";
    snap.forEach(async d=>{
      const p = d.data(); const id=d.id;
      const likedBy = p.likedBy||[]; 
      const iLiked = likedBy.includes(meId);
      const isOwner = p.userId===meId;

      let mediaHtml = "";
      if(p.fileUrl){
        const ext = p.fileUrl.split('.').pop().toLowerCase();
        if(['mp4','webm','ogg'].includes(ext)){
          mediaHtml = `<video class="post-media" src="${p.fileUrl}" controls></video>`;
        }else{
          mediaHtml = `<img class="post-media" src="${p.fileUrl}" alt="post">`;
        }
      }

      const post = el("div", `
        <div class="card" id="post-${id}">
          <div class="user-chip" onclick="viewUserProfile('${p.userId}')">
            <img class="mini" src="${p.userProfile||'https://i.ibb.co/4pVBB1K/default-avatar.png'}">
            <div><strong>${p.username}</strong></div>
          </div>
          <p>${p.text||""}</p>
          ${mediaHtml}
          <div class="row">
            <button onclick="toggleLike('${id}')">${iLiked?'💗':'🤍'} Like (${likedBy.length})</button>
            <button onclick="focusComment('${id}')">💬 Comment</button>
          </div>
          <div id="likes-${id}" class="likes"></div>
          <div id="comments-${id}"></div>
          <div class="comment-box">
            <input id="cinput-${id}" placeholder="Write a comment...">
            <button onclick="addComment('${id}')">Send</button>
          </div>
        </div>
      `);
      feed.appendChild(post);
      bindComments(id);
      bindLikes(id, likedBy);
    });
  });
}
window.bindPosts = bindPosts;

// ---------------- Likes ----------------
function bindLikes(postId, likedBy){
  const holder = $("#likes-"+postId); if(!holder) return;
  holder.innerHTML="";
  likedBy.forEach(async uid=>{
    const uDoc = await getDoc(doc(db,"users",uid));
    if(uDoc.exists()){
      const u = uDoc.data();
      const img = el("img", ""); 
      img.src = u.profilePic || "https://i.ibb.co/4pVBB1K/default-avatar.png";
      img.className = "mini";
      img.title = u.username || "User";
      img.onclick = ()=>viewUserProfile(uid);
      holder.appendChild(img);
    }
  });
}
window.bindLikes = bindLikes;

// ---------------- Comments ----------------
function bindComments(postId){
  const q = query(collection(db,"posts",postId,"comments"), orderBy("timestamp","asc"));
  onSnapshot(q, snap=>{
    const holder = $("#comments-"+postId); if(!holder) return;
    const all = snap.docs.map(d=>({id:d.id,...d.data()}));
    holder.innerHTML = all.map(c=>`
      <div class="comment">
        <img class="mini" src="${c.userPhoto||'https://i.ibb.co/4pVBB1K/default-avatar.png'}" onclick="viewUserProfile('${c.userId}')">
        <strong>${c.username}</strong>: ${c.text}
      </div>
    `).join("");
  });
}
window.bindComments = bindComments;

// ---------------- Profile ----------------
function openProfile(){
  $("#pFirst").value = me.firstName||""; 
  $("#pSurname").value = me.surname||""; 
  $("#pUsername").value=me.username||""; 
  $("#pDob").value = me.dob||"";
  $("#pPicPreview").src = me.profilePic || "https://i.ibb.co/4pVBB1K/default-avatar.png";
  openModal("profileModal");
}
window.openProfile = openProfile;

window.saveProfile = async ()=>{
  const firstName=$("#pFirst").value.trim(),
        surname=$("#pSurname").value.trim(),
        username=$("#pUsername").value.trim(),
        dob=$("#pDob").value;
  
  let photo = me.profilePic||"";
  const file=$("#pPic").files[0];
  if(file) photo = await uploadToCloudinary(file);

  await updateDoc(doc(db,"users",meId),{firstName,surname,username,dob,profilePic:photo});
  me={...me,firstName,surname,username,dob,profilePic:photo};
  $("#navProfilePic").src = photo||"https://i.ibb.co/4pVBB1K/default-avatar.png";
  $("#navUsername").textContent=username||"Username";
  closeModal("profileModal");
};

// ---------------- Modals ----------------
function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }
window.openModal = openModal; window.closeModal = closeModal;

// ---------------- Post Actions ----------------
async function uploadToCloudinary(file){
  const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", CLOUDINARY_PRESET);
  const r = await fetch(CLOUDINARY_URL,{method:"POST",body:fd}); const j = await r.json();
  if(!j.secure_url) throw new Error(j.error?.message||"Cloudinary upload failed");
  return j.secure_url;
}

async function uploadPost(){
  const file = $("#postFile").files[0]; const text = $("#postText").value.trim();
  if(!file && !text){ alert("Write something or pick a file"); return; }
  let url=""; if(file) url = await uploadToCloudinary(file);
  await addDoc(collection(db,"posts"),{
    userId:meId,
    username:me.username||"",
    userProfile:me.profilePic||"",
    text,
    fileUrl:url,
    timestamp:serverTimestamp(),
    likedBy:[]
  });
  $("#postText").value=""; $("#postFile").value="";
}

async function toggleLike(postId){
  const ref=doc(db,"posts",postId); const snap=await getDoc(ref); if(!snap.exists()) return;
  const likedBy=new Set(snap.data().likedBy||[]);
  likedBy.has(meId)? likedBy.delete(meId) : likedBy.add(meId);
  await updateDoc(ref,{likedBy:Array.from(likedBy)});
}

function focusComment(postId){ $("#cinput-"+postId)?.focus(); }

async function addComment(postId){ 
  const input=$("#cinput-"+postId); const text=input.value.trim(); if(!text) return;
  await addDoc(collection(db,"posts",postId,"comments"),{
    userId:meId,
    username:me.username||"",
    userPhoto:me.profilePic||"",
    text,
    parentId:null,
    timestamp:serverTimestamp()
  });
  input.value="";
}

window.uploadPost = uploadPost; 
window.toggleLike = toggleLike; 
window.focusComment = focusComment; 
window.addComment = addComment;

</script>
</body>
</html>
