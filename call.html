<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Call</title>
  <style>
    body {
      background:#121212;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:100vh;
      font-family:'Segoe UI', sans-serif;
    }
    h2 {
      margin-bottom:20px;
      color:#00ffea;
      text-shadow:0 0 10px #00ffea;
    }
    video {
      width:320px;
      height:240px;
      border-radius:12px;
      margin:10px;
      background:black;
      box-shadow:0 0 20px rgba(0,255,234,0.5);
    }
    #controls {
      margin-top:20px;
      display:flex;
      align-items:center;
      gap:15px;
    }
    button {
      background:#00ffea;
      border:none;
      border-radius:8px;
      padding:10px 20px;
      font-size:16px;
      cursor:pointer;
      color:#121212;
      transition: transform 0.2s, background 0.2s;
    }
    button:hover { transform:scale(1.05); background:#00cbbd; }
    label { display:flex; align-items:center; gap:8px; font-size:14px; }
    #timer { font-size:22px; margin-top:15px; color:#00ffea; text-shadow:0 0 5px #00ffea; }
  </style>
</head>
<body>
  <h2 id="callStatus">Connecting...</h2>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

  <div id="controls">
    <button id="muteBtn">Mute</button>
    <label>ðŸ”Š Volume:
      <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
    </label>
    <button id="endCallBtn">End Call</button>
  </div>
  <div id="timer">00:00</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDLSjPvdhLP4Esh9i0k4Fbe5W3YUlHas94",
  authDomain:"meet-your-love-3c2e9.firebaseapp.com",
  projectId:"meet-your-love-3c2e9",
  storageBucket:"meet-your-love-3c2e9.appspot.com",
  messagingSenderId:"762275409257",
  appId:"1:762275409257:web:374c366cfea5b01dae21f8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let localStream, peerConnection;
const config = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

const callFriendId = localStorage.getItem("callFriendId"); 
const callType = localStorage.getItem("callType") || 'video';

const callStatus = document.getElementById("callStatus");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const muteBtn = document.getElementById("muteBtn");
const endCallBtn = document.getElementById("endCallBtn");
const timerDisplay = document.getElementById("timer");
const volumeSlider = document.getElementById("volumeSlider");

let isMuted = false;
let seconds=0, minutes=0;
let timerInterval;
let remoteDescSet = false;
let pendingCandidates = [];

// Mute mic
muteBtn.onclick = () => {
  isMuted = !isMuted;
  if(localStream) localStream.getAudioTracks()[0].enabled = !isMuted;
  muteBtn.textContent = isMuted ? "Unmute" : "Mute";
};

// Remote volume
volumeSlider.oninput = () => {
  remoteVideo.volume = volumeSlider.value;
};

// Timer
function startTimer() {
  timerInterval = setInterval(()=>{
    seconds++;
    if(seconds>=60){ minutes++; seconds=0; }
    timerDisplay.textContent = `${minutes<10?'0'+minutes:minutes}:${seconds<10?'0'+seconds:seconds}`;
  },1000);
}

// End call
endCallBtn.onclick = async () => {
  peerConnection?.close();
  localStream?.getTracks().forEach(t=>t.stop());
  clearInterval(timerInterval);

  const callRef = doc(db,"calls",callFriendId);
  await setDoc(callRef,{ended:true},{merge:true});
  window.location.href="message.html";
};

// Start media & peer connection
async function startCallMedia(){
  try{
    localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:callType==='video'});
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track=>peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = e => { remoteVideo.srcObject = e.streams[0]; }

    const callRef = doc(db,"calls",callFriendId);

    // Listen for remote session & ICE
    onSnapshot(callRef, async (docSnap)=>{
      const data = docSnap.data();
      if(!data) return;

      // Set remote description safely
      if(data.answer && !remoteDescSet){
        if(data.answer.type && data.answer.sdp){
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
          remoteDescSet = true;

          // Add any pending ICE candidates
          for(const c of pendingCandidates){
            try{ await peerConnection.addIceCandidate(new RTCIceCandidate(c)); } catch(e){console.error(e);}
          }
          pendingCandidates=[];
        }
      }

      // Queue ICE candidates if remoteDesc not yet set
      if(data.candidates){
        for(const c of data.candidates){
          if(c){
            if(remoteDescSet){
              try{ await peerConnection.addIceCandidate(new RTCIceCandidate(c)); }
              catch(e){console.error(e);}
            } else {
              pendingCandidates.push(c);
            }
          }
        }
      }
    });

    // ICE candidates
    peerConnection.onicecandidate = e => {
      if(e.candidate){
        setDoc(callRef,{candidates:arrayUnion(e.candidate.toJSON())},{merge:true});
      }
    };

    const callDoc = await getDoc(callRef);
    if(!callDoc.exists()){
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      await setDoc(callRef,{offer:offer.toJSON(),candidates:[]});
    } else {
      const offerData = callDoc.data().offer;
      if(offerData && offerData.type && offerData.sdp){
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData));
        remoteDescSet = true;

        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        await setDoc(callRef,{answer:answer.toJSON()},{merge:true});
      }
    }

    callStatus.innerText="In Call";
    startTimer();

  } catch(e){
    console.error(e);
    alert("Failed to access media: "+e);
    callStatus.innerText="Error";
  }
}

startCallMedia();
</script>
</body>
</html>
