<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call - Meet Your Love</title>
<style>
  body { background:#121212; color:white; font-family:'Segoe UI',sans-serif; display:flex; flex-direction:column; align-items:center; padding:10px; }
  h2 { margin:10px 0; }
  #videos { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:10px 0; }
  video { border-radius:15px; background:black; width:160px; height:220px; object-fit:cover; }
  #controls { display:flex; gap:12px; margin-top:10px; }
  button { padding:10px 16px; border:none; border-radius:50px; cursor:pointer; font-size:16px; color:white; background:#2a2a2a; transition:0.2s; }
  button:hover { background:#3a3a3a; }
  #endBtn { background:#ef4444 !important; }
  #timer { margin-top:5px; font-weight:500; }
</style>
</head>
<body>
<h2>Call in progress...</h2>
<p id="timer">00:00</p>
<div id="videos">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>
<div id="controls">
  <button id="muteBtn">ğŸ”‡ Mute</button>
  <button id="videoBtn">ğŸ¥ Video</button>
  <button id="endBtn">âŒ End</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLSjPvdhLP4Esh9i0k4Fbe5W3YUlHas94",
  authDomain: "meet-your-love-3c2e9.firebaseapp.com",
  projectId: "meet-your-love-3c2e9",
  storageBucket: "meet-your-love-3c2e9.appspot.com",
  messagingSenderId: "762275409257",
  appId: "1:762275409257:web:374c366cfea5b01dae21f8"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const muteBtn = document.getElementById("muteBtn");
const videoBtn = document.getElementById("videoBtn");
const endBtn = document.getElementById("endBtn");
const timerEl = document.getElementById("timer");

let localStream, remoteStream, pc;
let callId = localStorage.getItem("pendingCallId");
let seconds = 0;
let timerInterval;

function startTimer(){
  timerInterval = setInterval(()=>{
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    timerEl.innerText = `${m}:${s}`;
  },1000);
}

async function getMedia(audio=true, video=false){
  return await navigator.mediaDevices.getUserMedia({ audio, video });
}

// --- WebRTC Setup ---
async function initCall(){
  localStream = await getMedia(true,true);
  localVideo.srcObject = localStream;
  remoteStream = new MediaStream();
  remoteVideo.srcObject = remoteStream;

  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = event => {
    event.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));
  };

  // Firestore signaling
  const callDoc = doc(db,"calls",callId);
  const offerCandidates = collection(callDoc,"offerCandidates");
  const answerCandidates = collection(callDoc,"answerCandidates");

  // Collect ICE candidates
  pc.onicecandidate = event=>{
    if(event.candidate) addDoc(offerCandidates,event.candidate.toJSON());
  };

  // Listen for remote ICE candidates
  onSnapshot(answerCandidates, snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added"){
        pc.addIceCandidate(change.doc.data());
      }
    });
  });

  // Listen if call ends
  onSnapshot(callDoc, snap=>{
    const data = snap.data();
    if(!data) return;
    if(data.status==="ended"){
      endCall();
      alert("Call ended");
    }
  });

  // Create Offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await updateDoc(callDoc,{ offer: { type: offer.type, sdp: offer.sdp } });

  // Listen for answer
  onSnapshot(callDoc, snap=>{
    const data = snap.data();
    if(data?.answer && !pc.currentRemoteDescription){
      const answerDesc = new RTCSessionDescription(data.answer);
      pc.setRemoteDescription(answerDesc);
    }
  });

  startTimer();
}

async function endCall(){
  clearInterval(timerInterval);
  localStream?.getTracks().forEach(t=>t.stop());
  remoteStream?.getTracks().forEach(t=>t.stop());
  pc?.close();
  // Update call status in Firestore
  if(callId) await updateDoc(doc(db,"calls",callId),{status:"ended"});
  localStorage.removeItem("pendingCallId");
  window.location.href="message.html";
}

muteBtn.onclick = ()=>{
  if(!localStream) return;
  localStream.getAudioTracks().forEach(t=>t.enabled = !t.enabled);
  muteBtn.innerText = localStream.getAudioTracks()[0].enabled ? "ğŸ”‡ Mute" : "ğŸ”Š Unmute";
};

videoBtn.onclick = ()=>{
  if(!localStream) return;
  localStream.getVideoTracks().forEach(t=>t.enabled = !t.enabled);
  videoBtn.innerText = localStream.getVideoTracks()[0].enabled ? "ğŸ¥ Video" : "ğŸ“µ Audio Only";
};

endBtn.onclick = endCall;

initCall();
</script>
</body>
</html>
