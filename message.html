<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meet Your Love - Messages</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#f0f2f5; }
nav { background:#ff4081; color:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
nav img { height:50px; width:50px; border-radius:50%; cursor:pointer; }
nav span { font-weight:bold; margin-left:10px; }
.container { max-width:1200px; margin:auto; padding:20px; }
.chat-window { background:#fff; border-radius:15px; padding:15px; max-height:60vh; overflow-y:auto; margin-bottom:10px; }
.chat-message { margin-bottom:10px; padding:5px 10px; border-radius:10px; max-width:80%; display:flex; gap:8px; align-items:flex-start; }
.chat-message.me { background:#ffdde1; margin-left:auto; flex-direction:row-reverse; }
.chat-message img.profile { width:35px; height:35px; border-radius:50%; object-fit:cover; }
.message-content { background:#f1f1f1; padding:10px; border-radius:12px; max-width:300px; word-wrap:break-word; }
.chat-message.me .message-content { background:#ffb6c1; }
.message-content img { max-width:200px; border-radius:10px; cursor:pointer; }
.message-content video, .message-content audio { max-width:200px; border-radius:10px; }
.file-card { display:flex; align-items:center; justify-content:space-between; background:#e0e0e0; padding:8px; border-radius:8px; margin-top:5px; font-size:0.9rem; }
.file-card a { text-decoration:none; color:#333; }
.file-card button { padding:5px 8px; border:none; background:#ff4081; color:white; border-radius:5px; cursor:pointer; }
.file-card button:hover { background:#e91e63; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:9999; }
.modal-content { background:#1f1f1f; padding:15px; border-radius:15px; max-width:90%; max-height:90%; overflow:auto; color:white; text-align:center; }
.modal-content img, .modal-content video { max-width:100%; border-radius:10px; }
.modal button { margin-top:10px; padding:8px 15px; }
.attachments { display:flex; gap:5px; margin-bottom:5px; align-items:center; }
.attachments input { display:none; }
</style>
</head>
<body>

<nav>
  <div class="flex">
    <img src="https://i.ibb.co/default-profile.png" id="navProfilePic" alt="Profile">
    <span id="navUsername">Username</span>
  </div>
  <div>
    <button onclick="goToMain()">Home</button>
  </div>
</nav>

<div class="container">
  <h3 id="chatFriendName">Chat</h3>
  <div class="chat-window" id="chatWindow"></div>

  <div class="attachments">
    <label for="attachFile">ðŸ“Ž</label>
    <input type="file" id="attachFile" multiple>
    <button id="recordBtn">ðŸŽ¤ Record</button>
  </div>

  <input type="text" id="chatInput" placeholder="Type a message...">
  <button id="sendMsgBtn">Send</button>
</div>

<!-- Modal for media preview -->
<div class="modal" id="mediaModal">
  <div class="modal-content" id="mediaContent"></div>
  <button onclick="closeMediaModal()">Close</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLSjPvdhLP4Esh9i0k4Fbe5W3YUlHas94",
  authDomain: "meet-your-love-3c2e9.firebaseapp.com",
  projectId: "meet-your-love-3c2e9",
  storageBucket: "meet-your-love-3c2e9.appspot.com",
  messagingSenderId: "762275409257",
  appId: "1:762275409257:web:374c366cfea5b01dae21f8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserId = "";
let currentChatFriend = "";
let currentChatFriendName = "";
let currentChatFriendPic = "";
let chatUnsub = null;

// Audio recording
let mediaRecorder = null;
let audioChunks = [];

// Load user info
onAuthStateChanged(auth, async user => {
  if(user){
    currentUserId = user.uid;
    const userDoc = await getDocs(collection(db,"users"));
    const data = userDoc.docs.find(d=>d.id===user.uid)?.data();
    if(data){
      document.getElementById("navProfilePic").src = data.profilePic || "https://i.ibb.co/default-profile.png";
      document.getElementById("navUsername").innerText = data.username || "Username";
    }

    currentChatFriend = localStorage.getItem("chatFriendId") || "";
    currentChatFriendName = localStorage.getItem("chatFriendName") || "";
    currentChatFriendPic = localStorage.getItem("chatFriendPic") || "";

    if(currentChatFriend){
      startChat(currentChatFriend, currentChatFriendName, currentChatFriendPic);
    }
  } else window.location.href="index.html";
});

function goToMain(){ window.location.href="main.html"; }

// Preview modal
function openMediaModal(url, type){
  const modal = document.getElementById("mediaModal");
  const content = document.getElementById("mediaContent");
  if(type==="image") content.innerHTML = `<img src="${url}">`;
  if(type==="video") content.innerHTML = `<video src="${url}" controls autoplay></video>`;
  modal.style.display = "flex";
}
function closeMediaModal(){ document.getElementById("mediaModal").style.display = "none"; }

// Cloudinary upload
async function uploadToCloudinary(file){
  const send = confirm(`Send "${file.name}"?`);
  if(!send) throw "Upload canceled";
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", "voice upload");
  const r = await fetch("https://api.cloudinary.com/v1_1/dcmudqqsp/upload",{method:"POST",body:fd});
  const j = await r.json();
  if(!j.secure_url) throw new Error("Upload failed");
  return j.secure_url;
}

// Start chat
async function startChat(friendId, friendName, friendPic){
  currentChatFriend = friendId;
  currentChatFriendName = friendName;
  currentChatFriendPic = friendPic;
  document.getElementById("chatFriendName").innerText = friendName;
  document.getElementById("chatWindow").innerHTML="";

  if(chatUnsub) chatUnsub();

  const chatCollection = collection(db,"messages");
  const chatQuery = query(chatCollection, orderBy("timestamp"));
  chatUnsub = onSnapshot(chatQuery, snap=>{
    const chatWindow = document.getElementById("chatWindow");
    chatWindow.innerHTML="";
    snap.forEach(docu=>{
      const msg = docu.data();
      if((msg.from===currentUserId && msg.to===currentChatFriend) || (msg.to===currentUserId && msg.from===currentChatFriend)){
        const div = document.createElement("div");
        div.className="chat-message" + (msg.from===currentUserId?" me":"");

        const profilePic = msg.from===currentUserId ? document.getElementById("navProfilePic").src : currentChatFriendPic;
        let contentHtml = "";

        if(msg.type==="text") contentHtml = `<div class="message-content">${msg.text}</div>`;
        else if(msg.type==="voice") contentHtml = `<div class="message-content"><audio controls src="${msg.fileUrl}"></audio><a href="${msg.fileUrl}" download>Download</a></div>`;
        else if(msg.type==="image") contentHtml = `<div class="message-content"><img src="${msg.fileUrl}" onclick="openMediaModal('${msg.fileUrl}','image')"></div>`;
        else if(msg.type==="video") contentHtml = `<div class="message-content"><video controls src="${msg.fileUrl}" onclick="openMediaModal('${msg.fileUrl}','video')"></video></div>`;
        else contentHtml = `<div class="message-content file-card"><span>${msg.fileUrl.split("/").pop()}</span> <a href="${msg.fileUrl}" download>Download</a></div>`;

        div.innerHTML = `
          ${msg.from!==currentUserId?`<img src="${profilePic}" class="profile">`:""}
          ${contentHtml}
          ${msg.from===currentUserId?`<img src="${profilePic}" class="profile">`:""}
        `;
        chatWindow.appendChild(div);
      }
    });
    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
}

// Send text
document.getElementById("sendMsgBtn").onclick = async ()=>{
  const text = document.getElementById("chatInput").value.trim();
  if(!text || !currentChatFriend) return alert("Select a friend to chat");
  await addDoc(collection(db,"messages"),{
    from: currentUserId,
    to: currentChatFriend,
    text,
    type:"text",
    timestamp: serverTimestamp(),
    read:false
  });
  document.getElementById("chatInput").value="";
}

// Attach files
document.getElementById("attachFile").onchange = async e=>{
  const files = e.target.files;
  for(let file of files){
    try{
      const url = await uploadToCloudinary(file);
      let type = "image";
      if(file.type.startsWith("audio")) type="voice";
      else if(file.type.startsWith("video")) type="video";
      else if(file.type.endsWith("pdf") || file.type==="application/msword" || file.type==="application/vnd.openxmlformats-officedocument.wordprocessingml.document") type="file";
      await addDoc(collection(db,"messages"),{
        from: currentUserId,
        to: currentChatFriend,
        fileUrl: url,
        type,
        timestamp: serverTimestamp(),
        read:false
      });
    }catch(err){ console.log(err); }
  }
  e.target.value="";
}

// Voice recording
document.getElementById("recordBtn").onclick = async ()=>{
  if(mediaRecorder && mediaRecorder.state==="recording"){ mediaRecorder.stop(); return; }
  if(!navigator.mediaDevices) return alert("No microphone found");
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
  mediaRecorder.onstop = async ()=>{
    const blob = new Blob(audioChunks, { type:"audio/mp3" });
    const file = new File([blob], "voice.mp3", { type:"audio/mp3" });
    try{
      const url = await uploadToCloudinary(file);
      await addDoc(collection(db,"messages"),{
        from: currentUserId,
        to: currentChatFriend,
        fileUrl: url,
        type:"voice",
        timestamp: serverTimestamp(),
        read:false
      });
    }catch(err){ console.log(err); }
  }
  mediaRecorder.start();
}
</script>
</body>
</html>
