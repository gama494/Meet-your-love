<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Meet Your Love - Messages</title>
<style>
  body { font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#121212; color:white; }
  nav { background:#1f1f1f; color:white; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
  nav .left { display:flex; align-items:center; gap:10px; }
  nav img { height:44px; width:44px; border-radius:50%; cursor:pointer; object-fit:cover; }
  nav .username { font-weight:600; }
  nav .actions { display:flex; gap:10px; align-items:center; }
  .icon-btn { background:#2a2a2a; border:none; border-radius:999px; width:42px; height:42px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
  .icon-btn:hover { background:#3a3a3a; }
  .container { max-width:1100px; margin:auto; padding:16px; }
  .chat-window { background:#1e1e1e; border-radius:16px; padding:14px; max-height:420px; overflow-y:auto; margin-bottom:10px; }
  .chat-message { margin-bottom:10px; padding:10px; border-radius:14px; max-width:80%; display:flex; gap:8px; align-items:flex-start; background:#262626; }
  .chat-message.me { background:#ff4081; margin-left:auto; color:white; flex-direction:row-reverse; }
  .chat-message img.profile { width:30px; height:30px; border-radius:50%; object-fit:cover; }
  .chat-message img.zoomable, .chat-message video.zoomable { max-width:150px; cursor:pointer; border-radius:10px; }
  .chat-message audio { outline:none; width:180px; }
  .pdf-link { display:inline-block; background:#333; padding:6px 10px; border-radius:10px; text-decoration:none; color:white; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  input, button { padding:10px; border-radius:10px; border:1px solid #333; margin-top:5px; background:#1e1e1e; color:white; }
  button { background:#ff4081; border:none; cursor:pointer; }
  button:hover { background:#e91e63; }
  #chatInput { width:calc(100% - 100px); }
  .attachments { display:flex; gap:8px; margin-bottom:6px; align-items:center; }
  .attachments input { display:none; }

  /* Modal (Media viewer) */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:90; }
  .modal-content { background:#1f1f1f; padding:15px; border-radius:15px; max-width:90%; max-height:90%; overflow:auto; color:white; text-align:center; }
  .modal img, .modal video { max-width:100%; border-radius:10px; }

  /* Incoming Call Popup */
  .call-popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:100; align-items:center; justify-content:center; }
  .call-card { width:92%; max-width:420px; background:#1b1b1b; border:1px solid #2a2a2a; border-radius:18px; padding:18px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
  .call-avatar { width:86px; height:86px; border-radius:50%; object-fit:cover; border:3px solid #2c2c2c; margin:10px auto; display:block; }
  .call-name { font-size:18px; font-weight:600; margin-top:6px; }
  .call-status { color:#bdbdbd; font-size:14px; margin:6px 0 14px; }
  .row { display:flex; gap:10px; justify-content:center; }
  .btn-decline { background:#ef4444; }
  .btn-accept  { background:#22c55e; }
  .toast { position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#262626; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #444; z-index:120; display:none; }

  /* Small helper badge at top when caller is waiting */
  .calling-banner { display:none; background:#0b5; color:#fff; padding:6px 10px; border-radius:12px; font-size:12px; }
</style>
</head>
<body>

<nav>
  <div class="left">
    <img src="https://i.ibb.co/default-profile.png" id="navProfilePic" alt="Profile">
    <span class="username" id="navUsername">Username</span>
    <span id="callingBanner" class="calling-banner">Callingâ€¦</span>
  </div>
  <div class="actions">
    <!-- Phone icon button -->
    <button id="callBtn" class="icon-btn" title="Call this person" aria-label="Call">
      <!-- Simple phone icon (SVG) -->
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72c.13.98.37 1.93.72 2.83a2 2 0 0 1-.45 2.11l-1.27 1.27a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.9.35 1.85.59 2.83.72A2 2 0 0 1 22 16.92z" fill="currentColor"/>
      </svg>
    </button>
  </div>
</nav>

<audio id="msgSound" src="notification.mp3" preload="auto"></audio>
<audio id="ringtone" src="ringtone.mp3" preload="auto" loop></audio>

<div class="container">
  <h3 id="chatFriendName">Chat</h3>
  <div class="chat-window" id="chatWindow"></div>

  <div class="attachments">
    <label>ðŸ“Ž
      <input type="file" id="attachFile" accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
    </label>
    <button id="recordBtn">ðŸŽ¤ Record</button>
    <span id="voiceTimer">00:00</span>
  </div>

  <input type="text" id="chatInput" placeholder="Type a message...">
  <button id="sendMsgBtn">Send</button>
</div>

<!-- Media viewer -->
<div class="modal" id="mediaModal">
  <div class="modal-content" id="mediaContent"></div>
  <button onclick="closeMediaModal()">Close</button>
</div>

<!-- Incoming Call Popup -->
<div id="incomingPopup" class="call-popup" role="dialog" aria-modal="true">
  <div class="call-card">
    <img id="incomingAvatar" class="call-avatar" src="https://i.ibb.co/default-profile.png" alt="">
    <div id="incomingName" class="call-name">Incoming call</div>
    <div class="call-status">Ringingâ€¦</div>
    <div class="row">
      <button id="declineBtn" class="btn-decline">Decline</button>
      <button id="acceptBtn" class="btn-accept">Answer</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
/* ---------------- Firebase ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, addDoc, setDoc, updateDoc,
  query, orderBy, onSnapshot, serverTimestamp, where
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLSjPvdhLP4Esh9i0k4Fbe5W3YUlHas94",
  authDomain: "meet-your-love-3c2e9.firebaseapp.com",
  projectId: "meet-your-love-3c2e9",
  storageBucket: "meet-your-love-3c2e9.appspot.com",
  messagingSenderId: "762275409257",
  appId: "1:762275409257:web:374c366cfea5b01dae21f8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- State ---------------- */
let currentUserId = "";
let currentChatFriend = "";
let currentChatFriendName = "";
let currentChatFriendPic = "";
let chatUnsub = null;

let mediaRecorder = null;
let audioChunks = [];
let seconds = 0;
let timerInterval = null;

const ringtone = document.getElementById("ringtone");
const callingBanner = document.getElementById("callingBanner");
const incomingPopup = document.getElementById("incomingPopup");
const incomingName = document.getElementById("incomingName");
const incomingAvatar = document.getElementById("incomingAvatar");
const acceptBtn = document.getElementById("acceptBtn");
const declineBtn = document.getElementById("declineBtn");
const toastEl = document.getElementById("toast");

/* ---------------- Helpers ---------------- */
function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(()=> toastEl.style.display = "none", 2200);
}
function openMediaModal(url,type){
  const modal = document.getElementById("mediaModal");
  const content = document.getElementById("mediaContent");
  if(type==="image") content.innerHTML=`<img src="${url}" />`;
  else if(type==="video") content.innerHTML=`<video src="${url}" controls autoplay></video>`;
  else if(type==="voice") content.innerHTML=`<audio src="${url}" controls autoplay></audio>`;
  else content.innerHTML=`<a href="${url}" target="_blank">Open File</a>`;
  modal.style.display="flex";
}
window.closeMediaModal = function(){ document.getElementById("mediaModal").style.display="none"; };
function goToMain(){ window.location.href="main.html"; }

/* ---------------- Call Signaling ---------------- */
/**
 * Schema (calls collection):
 * - callId (doc id)
 * - callerId, callerName, callerPic
 * - receiverId, receiverName, receiverPic
 * - callType: "audio" | "video"
 * - status: "ringing" | "accepted" | "declined" | "ended"
 * - createdAt
 */
const CALLS = collection(db, "calls");

// Caller: start a call to currentChatFriend
const callBtn = document.getElementById("callBtn");
callBtn.onclick = async () => {
  if(!currentChatFriend) { showToast("Open a chat first."); return; }
  if(!currentUserId) { showToast("Not signed in."); return; }

  // Create a new call doc with random id (safer for concurrent calls)
  const callDocRef = await addDoc(CALLS, {
    callerId: currentUserId,
    callerName: document.getElementById("navUsername").textContent || "Me",
    callerPic: document.getElementById("navProfilePic").src || "",
    receiverId: currentChatFriend,
    receiverName: currentChatFriendName || "",
    receiverPic: currentChatFriendPic || "",
    callType: "video",                    // or "audio" if you add a toggle
    status: "ringing",
    createdAt: serverTimestamp()
  });

  const callId = callDocRef.id;
  localStorage.setItem("pendingCallId", callId);
  localStorage.setItem("callFriendId", currentChatFriend);       // used by call.html
  localStorage.setItem("callType", "video");

  callingBanner.style.display = "inline-flex";
  showToast("Callingâ€¦");

  // Listen for status changes for this call
  onSnapshot(doc(db, "calls", callId), (snap)=>{
    const data = snap.data();
    if(!data) return;
    if(data.status === "accepted"){
      callingBanner.style.display = "none";
      // Go to call.html for both
      window.location.href = "call.html";
    } else if(data.status === "declined") {
      callingBanner.style.display = "none";
      showToast("Call declined");
      // Optionally clean up
    } else if(data.status === "ended") {
      callingBanner.style.display = "none";
      showToast("Call ended");
    }
  });
};

// Receiver: listen for any incoming ringing calls for me
function listenIncomingCalls() {
  if(!currentUserId) return;
  const qIncoming = query(CALLS, where("receiverId", "==", currentUserId), where("status","==","ringing"));
  onSnapshot(qIncoming, (snap)=>{
    snap.docChanges().forEach(async (change)=>{
      if(change.type === "added"){
        const callId = change.doc.id;
        const call = change.doc.data();

        // Show popup & play ringtone
        incomingName.textContent = call.callerName || "Incoming call";
        incomingAvatar.src = call.callerPic || "https://i.ibb.co/default-profile.png";
        incomingPopup.style.display = "flex";
        try { await ringtone.play(); } catch(_) {}

        // Bind buttons (unbind first to avoid stacking)
        acceptBtn.onclick = async ()=>{
          try {
            await updateDoc(doc(db,"calls",callId), { status: "accepted" });
            incomingPopup.style.display = "none";
            ringtone.pause(); ringtone.currentTime = 0;

            // Set localStorage so call.html knows the friend & type
            localStorage.setItem("callFriendId", call.callerId);
            localStorage.setItem("callType", call.callType || "video");
            localStorage.setItem("pendingCallId", callId);

            window.location.href = "call.html";
          } catch(e){ console.error(e); showToast("Error accepting call"); }
        };

        declineBtn.onclick = async ()=>{
          try {
            await updateDoc(doc(db,"calls",callId), { status: "declined" });
            incomingPopup.style.display = "none";
            ringtone.pause(); ringtone.currentTime = 0;
          } catch(e){ console.error(e); showToast("Error declining call"); }
        };
      }
    });
  });
}

// Caller also listens if callee declines on a different session (handled above in callBtn snapshot)

/* ---------------- Auth & Chat ---------------- */
onAuthStateChanged(auth, async user => {
  if(user){
    currentUserId = user.uid;

    // Load my profile for nav
    const meSnap = await getDoc(doc(db, "users", user.uid));
    if(meSnap.exists()){
      const me = meSnap.data();
      document.getElementById("navProfilePic").src = me.profilePic || "https://i.ibb.co/default-profile.png";
      document.getElementById("navUsername").innerText = me.username || "Username";
    }

    // Load current chat friend from localStorage (you already set these elsewhere)
    currentChatFriend = localStorage.getItem("chatFriendId") || "";
    currentChatFriendName = localStorage.getItem("chatFriendName") || "";
    currentChatFriendPic = localStorage.getItem("chatFriendPic") || "";

    if(currentChatFriend){
      document.getElementById("chatFriendName").innerText = currentChatFriendName || "Chat";
      startChat(currentChatFriend, currentChatFriendName, currentChatFriendPic);
    }

    // Sounds for normal messages
    listenGlobalMessages();
    // Start incoming call listener
    listenIncomingCalls();

  } else {
    window.location.href="index.html";
  }
});

/* ---------- Chat: your original messaging code ---------- */
async function uploadToCloudinary(file){
  if(!confirm(`Send ${file.name}?`)) return null;
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", "voice upload"); // Replace with your preset
  const r = await fetch("https://api.cloudinary.com/v1_1/dcmudqqsp/upload",{method:"POST",body:fd});
  const j = await r.json();
  return j.secure_url;
}

function startChat(friendId, friendName, friendPic){
  currentChatFriend = friendId;
  currentChatFriendName = friendName;
  currentChatFriendPic = friendPic;
  document.getElementById("chatFriendName").innerText = friendName;
  const chatWindow = document.getElementById("chatWindow");
  chatWindow.innerHTML="";

  if(chatUnsub) chatUnsub();

  const chatCollection = collection(db,"messages");
  const chatQuery = query(chatCollection, orderBy("timestamp"));
  chatUnsub = onSnapshot(chatQuery, snap=>{
    chatWindow.innerHTML="";
    snap.forEach(docu=>{
      const msg = docu.data();
      const mine = (msg.from===currentUserId && msg.to===currentChatFriend);
      const theirs = (msg.to===currentUserId && msg.from===currentChatFriend);
      if(mine || theirs){
        const div = document.createElement("div");
        div.className = "chat-message" + (mine?" me":"");
        const profilePic = mine ? document.getElementById("navProfilePic").src : currentChatFriendPic;

        let content = "";
        if(msg.type==="text") content = msg.text;
        else if(msg.type==="voice") content = `<audio controls src="${msg.fileUrl}"></audio>`;
        else if(msg.type==="image") content = `<img src="${msg.fileUrl}" class="zoomable">`;
        else if(msg.type==="video") content = `<video src="${msg.fileUrl}" controls class="zoomable"></video>`;
        else if(msg.type==="pdf" || msg.type==="doc") content = `<a href="${msg.fileUrl}" class="pdf-link" target="_blank">ðŸ“„ ${msg.fileUrl.split("/").pop()}</a>`;

        div.innerHTML = `
          ${!mine?`<img src="${profilePic}" class="profile">`:""}
          <div style="display:flex; flex-direction:column;">
            <strong>${mine?"Me":currentChatFriendName}:</strong>
            ${content}
          </div>
          ${mine?`<img src="${profilePic}" class="profile">`:""}
        `;
        chatWindow.appendChild(div);

        div.querySelectorAll(".zoomable").forEach(el=>{
          el.addEventListener("click", ()=> openMediaModal(el.src, el.tagName.toLowerCase()));
        });
      }
    });
    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
}

document.getElementById("sendMsgBtn").onclick = async ()=>{
  const text = document.getElementById("chatInput").value.trim();
  if(!text || !currentChatFriend) return alert("Select a friend to chat");
  await addDoc(collection(db,"messages"),{
    from: currentUserId,
    to: currentChatFriend,
    text,
    type:"text",
    timestamp: serverTimestamp(),
    read:false
  });
  document.getElementById("chatInput").value="";
};

document.getElementById("attachFile").onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file || !currentChatFriend) return;
  let type = "image";
  if(file.type.startsWith("audio")) type="voice";
  else if(file.type.startsWith("video")) type="video";
  else if(file.type==="application/pdf") type="pdf";
  else if(file.type==="application/msword" || file.type==="application/vnd.openxmlformats-officedocument.wordprocessingml.document") type="doc";
  const url = await uploadToCloudinary(file);
  if(!url) return;
  await addDoc(collection(db,"messages"),{
    from: currentUserId,
    to: currentChatFriend,
    fileUrl: url,
    type,
    timestamp: serverTimestamp(),
    read:false
  });
  e.target.value="";
};

function listenGlobalMessages() {
  const q = query(collection(db, "messages"), where("to", "==", currentUserId));
  onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if(change.type === "added"){
        document.getElementById("msgSound").play();
      }
    });
  });
}

// Voice recorder (unchanged)
const recordBtn = document.getElementById("recordBtn");
const voiceTimer = document.getElementById("voiceTimer");
recordBtn.onclick = async ()=>{
  if(mediaRecorder && mediaRecorder.state==="recording"){
    mediaRecorder.stop();
    return;
  }
  if(!navigator.mediaDevices) return alert("No microphone found");
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  seconds=0;
  voiceTimer.innerText="00:00";

  mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
  mediaRecorder.onstop = async ()=>{
    clearInterval(timerInterval);
    const blob = new Blob(audioChunks,{type:"audio/webm"});
    const file = new File([blob],"voice.webm",{type:"audio/webm"});
    const url = await uploadToCloudinary(file);
    if(!url) return;
    await addDoc(collection(db,"messages"),{
      from: currentUserId,
      to: currentChatFriend,
      fileUrl:url,
      type:"voice",
      timestamp: serverTimestamp(),
      read:false
    });
  };

  mediaRecorder.start();
  timerInterval = setInterval(()=>{
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    voiceTimer.innerText=`${m}:${s}`;
  },1000);
};


</script>
</body>
</html>
