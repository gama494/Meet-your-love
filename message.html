<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meet Your Love - Messages</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#121212; color:white; }
nav { background:#1f1f1f; color:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
nav img { height:50px; width:50px; border-radius:50%; cursor:pointer; }
nav span { font-weight:bold; margin-left:10px; }
.container { max-width:1200px; margin:auto; padding:20px; }
.chat-window { background:#1e1e1e; border-radius:15px; padding:15px; max-height:400px; overflow-y:auto; margin-bottom:10px; }
.chat-message { margin-bottom:10px; padding:10px; border-radius:15px; max-width:80%; display:flex; gap:8px; align-items:flex-start; }
.chat-message.me { background:#ff4081; margin-left:auto; flex-direction:row-reverse; color:white; }
.chat-message img.profile { width:30px; height:30px; border-radius:50%; }
.chat-message img.zoomable, .chat-message video.zoomable { max-width:150px; cursor:pointer; border-radius:10px; }
.chat-message audio { outline:none; width:150px; }
.pdf-link { display:block; background:#333; padding:5px; border-radius:10px; text-decoration:none; color:white; max-width:150px; }
input, button { padding:10px; border-radius:10px; border:1px solid #333; margin-top:5px; background:#1e1e1e; color:white; }
button { background:#ff4081; color:white; border:none; cursor:pointer; }
button:hover { background:#e91e63; }
#chatInput { width:calc(100% - 100px); }
.attachments { display:flex; gap:5px; margin-bottom:5px; align-items:center; }
.attachments input { display:none; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:9999; }
.modal-content { background:#1f1f1f; padding:15px; border-radius:15px; max-width:90%; max-height:90%; overflow:auto; color:white; text-align:center; }
.modal img, .modal video { max-width:100%; border-radius:10px; }
.modal button { margin-top:10px; }
</style>
</head>
<body>

<nav>
  <div class="flex">
    <img src="https://i.ibb.co/default-profile.png" id="navProfilePic" alt="Profile">
    <span id="navUsername">Username</span>
  </div>
  <div>
    <button onclick="goToMain()">Home</button>
  </div>
    <!-- 4K Call Icon Button -->
    <button id="callBtn" style="background:none; border:none; cursor:pointer;">
      <img src="https://cdn-icons-png.flaticon.com/512/483/483947.png" 
           alt="Call" 
           style="width:40px; height:40px;">
    </button>
  </div>
</nav>
<audio id="msgSound" src="notification.mp3" preload="auto"></audio>

<div class="container">
  <h3 id="chatFriendName">Chat</h3>
  <div class="chat-window" id="chatWindow"></div>

  <div class="attachments">
    <label>ðŸ“Ž
      <input type="file" id="attachFile" accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
    </label>
    <button id="recordBtn">ðŸŽ¤ Record</button>
    <span id="voiceTimer">00:00</span>
  </div>

  <input type="text" id="chatInput" placeholder="Type a message...">
  <button id="sendMsgBtn">Send</button>
</div>

<!-- Media Modal -->
<div class="modal" id="mediaModal">
  <div class="modal-content" id="mediaContent"></div>
  <button onclick="closeMediaModal()">Close</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, addDoc, query, orderBy, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLSjPvdhLP4Esh9i0k4Fbe5W3YUlHas94",
  authDomain: "meet-your-love-3c2e9.firebaseapp.com",
  projectId: "meet-your-love-3c2e9",
  storageBucket: "meet-your-love-3c2e9.appspot.com",
  messagingSenderId: "762275409257",
  appId: "1:762275409257:web:374c366cfea5b01dae21f8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserId = "";
let currentChatFriend = "";
let currentChatFriendName = "";
let currentChatFriendPic = "";
let chatUnsub = null;

let mediaRecorder = null;
let audioChunks = [];
let seconds = 0;
let timerInterval = null;


const callBtn = document.getElementById("callBtn");

callBtn.onclick = () => {
  // Set friend ID and call type
  localStorage.setItem("callFriendId", "FRIEND_USER_ID"); // replace with real friend ID
  localStorage.setItem("callType", "video"); // or 'audio'

  // Redirect to call.html
  window.location.href = "call.html";
}

// Load user info
onAuthStateChanged(auth, async user => {
  if(user){
    currentUserId = user.uid;
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if(userSnap.exists()){
      const data = userSnap.data();
      document.getElementById("navProfilePic").src = data.profilePic || "https://i.ibb.co/default-profile.png";
      document.getElementById("navUsername").innerText = data.username || "Username";
    }

    currentChatFriend = localStorage.getItem("chatFriendId") || "";
    currentChatFriendName = localStorage.getItem("chatFriendName") || "";
    currentChatFriendPic = localStorage.getItem("chatFriendPic") || "";

    if(currentChatFriend){
      document.getElementById("chatFriendName").innerText = currentChatFriendName || "Chat";
      startChat(currentChatFriend, currentChatFriendName, currentChatFriendPic);
    }
    
    // Start global message listener for sound
    listenGlobalMessages();
    
  } else window.location.href="index.html";
});

function goToMain(){ window.location.href="main.html"; }




// Upload to Cloudinary
async function uploadToCloudinary(file){
  if(!confirm(`Send ${file.name}?`)) return null;
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", "voice upload"); // Replace with your preset
  const r = await fetch("https://api.cloudinary.com/v1_1/dcmudqqsp/upload",{method:"POST",body:fd});
  const j = await r.json();
  return j.secure_url;
}

// Start chat
function startChat(friendId, friendName, friendPic){
  currentChatFriend = friendId;
  currentChatFriendName = friendName;
  currentChatFriendPic = friendPic;
  document.getElementById("chatFriendName").innerText = friendName;
  const chatWindow = document.getElementById("chatWindow");
  chatWindow.innerHTML="";

  if(chatUnsub) chatUnsub();

  const chatCollection = collection(db,"messages");
  const chatQuery = query(chatCollection, orderBy("timestamp"));
  chatUnsub = onSnapshot(chatQuery, snap=>{
    chatWindow.innerHTML="";
    snap.forEach(docu=>{
      const msg = docu.data();
      if((msg.from===currentUserId && msg.to===currentChatFriend) || (msg.to===currentUserId && msg.from===currentChatFriend)){
        const div = document.createElement("div");
        div.className = "chat-message" + (msg.from===currentUserId?" me":"");
        const profilePic = msg.from===currentUserId ? document.getElementById("navProfilePic").src : currentChatFriendPic;

        let content = "";
        if(msg.type==="text") content = msg.text;
        else if(msg.type==="voice") content = `<audio controls src="${msg.fileUrl}"></audio>`;
        else if(msg.type==="image") content = `<img src="${msg.fileUrl}" class="zoomable">`;
        else if(msg.type==="video") content = `<video src="${msg.fileUrl}" controls class="zoomable"></video>`;
        else if(msg.type==="pdf" || msg.type==="doc") content = `<a href="${msg.fileUrl}" class="pdf-link" target="_blank">ðŸ“„ ${msg.fileUrl.split("/").pop()}</a>`;

        div.innerHTML = `
          ${msg.from!==currentUserId?`<img src="${profilePic}" class="profile">`:""}
          <div style="display:flex; flex-direction:column;">
            <strong>${msg.from===currentUserId?"Me":currentChatFriendName}:</strong>
            ${content}
          </div>
          ${msg.from===currentUserId?`<img src="${profilePic}" class="profile">`:""}
        `;
        chatWindow.appendChild(div);

        div.querySelectorAll(".zoomable").forEach(el=>{
          el.addEventListener("click", ()=> openMediaModal(el.src, el.tagName.toLowerCase()));
        });
      }
    });
    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
}

// Send text
document.getElementById("sendMsgBtn").onclick = async ()=>{
  const text = document.getElementById("chatInput").value.trim();
  if(!text || !currentChatFriend) return alert("Select a friend to chat");
  await addDoc(collection(db,"messages"),{
    from: currentUserId,
    to: currentChatFriend,
    text,
    type:"text",
    timestamp: serverTimestamp(),
    read:false
  });
  document.getElementById("chatInput").value="";
}

// File attachment
document.getElementById("attachFile").onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file || !currentChatFriend) return;
  let type = "image";
  if(file.type.startsWith("audio")) type="voice";
  else if(file.type.startsWith("video")) type="video";
  else if(file.type==="application/pdf") type="pdf";
  else if(file.type==="application/msword" || file.type==="application/vnd.openxmlformats-officedocument.wordprocessingml.document") type="doc";
  const url = await uploadToCloudinary(file);
  if(!url) return;
  await addDoc(collection(db,"messages"),{
    from: currentUserId,
    to: currentChatFriend,
    fileUrl: url,
    type,
    timestamp: serverTimestamp(),
    read:false
  });
  e.target.value="";
}

window.closeMediaModal = function() {
  document.getElementById("mediaModal").style.display = "none";
}

// Listen for all incoming messages to me
function listenGlobalMessages() {
  const q = query(collection(db, "messages"), where("to", "==", currentUserId));
  onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if(change.type === "added"){
        document.getElementById("msgSound").play();
      }
    });
  });
}

// Media Modal
function openMediaModal(url,type){
  const modal = document.getElementById("mediaModal");
  const content = document.getElementById("mediaContent");
  if(type==="image") content.innerHTML=`<img src="${url}">`;
  else if(type==="video") content.innerHTML=`<video src="${url}" controls autoplay></video>`;
  else if(type==="voice") content.innerHTML=`<audio src="${url}" controls autoplay></audio>`;
  else content.innerHTML=`<a href="${url}" target="_blank">Open File</a>`;
  modal.style.display="flex";
}
function closeMediaModal(){ document.getElementById("mediaModal").style.display="none"; }

// Voice recorder
const recordBtn = document.getElementById("recordBtn");
const voiceTimer = document.getElementById("voiceTimer");
recordBtn.onclick = async ()=>{
  if(mediaRecorder && mediaRecorder.state==="recording"){
    mediaRecorder.stop();
    return;
  }
  if(!navigator.mediaDevices) return alert("No microphone found");
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  seconds=0;
  voiceTimer.innerText="00:00";

  mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
  mediaRecorder.onstop = async ()=>{
    clearInterval(timerInterval);
    const blob = new Blob(audioChunks,{type:"audio/webm"});
    const file = new File([blob],"voice.webm",{type:"audio/webm"});
    const url = await uploadToCloudinary(file);
    if(!url) return;
    await addDoc(collection(db,"messages"),{
      from: currentUserId,
      to: currentChatFriend,
      fileUrl:url,
      type:"voice",
      timestamp: serverTimestamp(),
      read:false
    });
  }

  mediaRecorder.start();
  timerInterval = setInterval(()=>{
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    voiceTimer.innerText=`${m}:${s}`;
  },1000);
}


// --- Call Notification ---
const notificationContainer = document.createElement("div");
notificationContainer.id = "callNotification";
notificationContainer.style.position = "fixed";
notificationContainer.style.bottom = "20px";
notificationContainer.style.right = "20px";
notificationContainer.style.background = "#00ffea";
notificationContainer.style.color = "#121212";
notificationContainer.style.padding = "15px";
notificationContainer.style.borderRadius = "10px";
notificationContainer.style.boxShadow = "0 0 15px rgba(0,255,234,0.5)";
notificationContainer.style.display = "none";
notificationContainer.style.flexDirection = "column";
notificationContainer.style.gap = "10px";
notificationContainer.style.zIndex = "999";
document.body.appendChild(notificationContainer);

const messageText = document.createElement("span");
messageText.innerText = "Incoming Call";
notificationContainer.appendChild(messageText);

const btnContainer = document.createElement("div");
btnContainer.style.display = "flex";
btnContainer.style.gap = "10px";
notificationContainer.appendChild(btnContainer);

const acceptBtn = document.createElement("button");
acceptBtn.innerText = "Accept";
acceptBtn.style.background = "#00cbbd";
acceptBtn.style.color = "#121212";
acceptBtn.style.border = "none";
acceptBtn.style.padding = "8px 15px";
acceptBtn.style.borderRadius = "8px";
acceptBtn.style.cursor = "pointer";
btnContainer.appendChild(acceptBtn);

const declineBtn = document.createElement("button");
declineBtn.innerText = "Decline";
declineBtn.style.background = "#ff4d4d";
declineBtn.style.color = "#121212";
declineBtn.style.border = "none";
declineBtn.style.padding = "8px 15px";
declineBtn.style.borderRadius = "8px";
declineBtn.style.cursor = "pointer";
btnContainer.appendChild(declineBtn);

function listenIncomingCalls(){
  const callRef = doc(db, "calls", currentUserId);
  onSnapshot(callRef, async (docSnap)=>{
    const data = docSnap.data();
    if(!data) return;
    if(data.callerId && !data.answered && !data.ended){
      notificationContainer.style.display = "flex";
      messageText.innerText = `Incoming call from ${data.callerName || "Friend"}`;
    } else {
      notificationContainer.style.display = "none";
    }
  });
}

acceptBtn.onclick = async ()=>{
  const callRef = doc(db, "calls", currentUserId);
  const callData = (await getDoc(callRef)).data();
  if(!callData) return;
  await updateDoc(callRef, { answered:true });
  localStorage.setItem("callFriendId", callData.callerId);
  localStorage.setItem("callType", callData.callType || "video");
  window.location.href="call.html";
};

declineBtn.onclick = async ()=>{
  const callRef = doc(db, "calls", currentUserId);
  await updateDoc(callRef, { ended:true });
  notificationContainer.style.display = "none";
};

// --- Existing Chat and Media Code ---
// Upload to Cloudinary, startChat, sendMsgBtn, attachFile, mediaModal, voice recorder
// Keep your previous functions as-is here...

</script>
</body>
</html>
